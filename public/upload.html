<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Media</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>
            <span class="fancy-text">Birthday</span>
            <span class="photo-text">Photo</span>
            <span class="share-text">Share</span>
        </h1>
        <div class="upload-container">
            <form id="uploadForm">
                <div class="file-input-container">
                    <input type="file" id="mediaInput" name="media" accept="image/*,video/*" required>
                    <label for="mediaInput" class="custom-file-input">Choose File</label>
                </div>
                <button type="submit" class="upload-button">Upload</button>
            </form>
            <div id="uploadStatus" class="upload-status"></div>
            <div id="progressBar" class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
        </div>
    </div>

    <script>
        const CLOUDINARY_CLOUD_NAME = 'dtrnwnuju';
        const CLOUDINARY_UPLOAD_PRESET = 'party_photos_preset';

        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const statusDiv = document.getElementById('uploadStatus');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const fileInput = document.getElementById('mediaInput');
            const file = fileInput.files[0];

            if (!file) {
                statusDiv.textContent = 'Please select a file';
                return;
            }

            statusDiv.textContent = 'Uploading...';
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';

            try {
                let uploadUrl;
                if (file.type.startsWith('video/') || file.size > 100 * 1024 * 1024) {
                    // Direct upload to Cloudinary for videos and large files
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                    formData.append('folder', 'party-photos');
                    formData.append('resource_type', 'auto'); // Let Cloudinary auto-detect the resource type

                    const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.text();
                        console.error('Cloudinary error:', errorData);
                        throw new Error(`Upload failed: ${response.statusText}. ${errorData}`);
                    }

                    const result = await response.json();
                    console.log('Cloudinary response:', result);
                    uploadUrl = result.secure_url;
                } else {
                    // Use server endpoint for smaller files
                    const formData = new FormData();
                    formData.append('media', file);

                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`Upload failed: ${response.statusText}`);
                    }

                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.message);
                    }
                    uploadUrl = result.data.url;
                }

                statusDiv.textContent = 'Upload successful!';
                progressFill.style.width = '100%';
                fileInput.value = ''; // Clear the file input

                // Redirect to gallery after 1 second
                setTimeout(() => {
                    window.location.href = '/gallery.html';
                }, 1000);
            } catch (error) {
                console.error('Upload error:', error);
                statusDiv.textContent = `Upload failed: ${error.message}`;
                progressBar.style.display = 'none';
            }
        });

        // Update file input label with selected filename
        document.getElementById('mediaInput').addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name || 'Choose File';
            const label = document.querySelector('.custom-file-input');
            label.textContent = fileName;
        });
    </script>
</body>
</html> 